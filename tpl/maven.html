<!--
******************************************************************************
                         MAVEN
******************************************************************************
-->
        <h2><a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>Maven.</h2>
        
<h3>Introduction</h3>

<p>
Maven est un outil permettant de gérer les dépendances, la compilation, le "packaging" et bien d'autres choses ... Il s'utilise au moyen de fichier "pom" décrivant votre projet.<br/>
Maven est développé en Java et le script "mvn" utilise la variable d'environement "JAVA_HOME" pour déterminer quelle version de java doit être utilisée. Afin d'éviter tout soucis, initialiser cette variable dans votre ".bashrc" (linux) ou ".bash_profile" (mac) ou dans les propriétés systèmes sous windows.<br/>
<code>export JAVA_HOME="/path/to/your/java/Home"</code>
</p>

<p>
  Page de téléchargement de maven : <a href="http://maven.apache.org/download.cgi">maven.apache.org/download.html</a><br/>
  <a href="http://mir2.ovh.net/ftp.apache.org/dist/maven/maven-3/3.3.3/binaries/apache-maven-3.3.3-bin.tar.gz">Archive maven 3.3.3</a> à extraire. Ajouter le répertoire bin à votre PATH, puis vérifier en tapant <i>mvn -v</i> ; vous devriez obtenir quelquechose de ce type :
</p>

<pre><code>
Apache Maven 3.3.3 (7994120775791599e205a5524ec3e0dfe41d4a06; 2015-04-22T13:57:37+02:00)
Maven home: /Users/guillaume/install/apache-maven-3.3.3
Java version: 1.8.0_11, vendor: Oracle Corporation
Java home: /Library/Java/JavaVirtualMachines/jdk1.8.0_11.jdk/Contents/Home/jre
Default locale: fr_FR, platform encoding: UTF-8
OS name: "mac os x", version: "10.10.2", arch: "x86_64", family: "mac"
</code></pre>

<p>
  Le principal intérêt de maven est de gérer des dépendances vers des librairies. Ces librairies sont téléchargées depuis un "repository", généralement le repository "central" maven.<br/>
  A l'université, les connexions sur le web doivent passées par le proxy cache. Pour que maven utilise le proxy, il faut modifier le fichier "settings.xml"
  situé dans votre 'HOME', dans le répertoire '.m2'<br/>
</p>

<p>contenu du fichier settings.xml pour la configuration proxy</p>

<pre><code>
&lt;settings&gt;
  &lt;proxies&gt;
   &lt;proxy&gt;
      &lt;active&gt;true&lt;/active&gt;
      &lt;protocol&gt;http&lt;/protocol&gt;
      &lt;host&gt;cache-etu.univ-lille1.fr&lt;/host&gt;
      &lt;port&gt;3128&lt;/port&gt;
      &lt;username&gt;&lt;/username&gt;
      &lt;password&gt;&lt;/password&gt;
      &lt;nonProxyHosts&gt;localhost|127.0.0.1&lt;/nonProxyHosts&gt;
    &lt;/proxy&gt;
    &lt;proxy&gt;
       &lt;active&gt;true&lt;/active&gt;
       &lt;protocol&gt;https&lt;/protocol&gt;
       &lt;host&gt;cache-etu.univ-lille1.fr&lt;/host&gt;
       &lt;port&gt;3128&lt;/port&gt;
       &lt;username&gt;&lt;/username&gt;
       &lt;password&gt;&lt;/password&gt;
       &lt;nonProxyHosts&gt;localhost|127.0.0.1&lt;/nonProxyHosts&gt;
     &lt;/proxy&gt;
  &lt;/proxies&gt;
&lt;/settings&gt;
</code></pre>

<p>
  Lorsque vous n'êtes pas sur le réseau de l'université pensez à désactiver le proxy ! : &lt;active&gt;<b>false</b>&lt;/active&gt;
</p>

<p>
Le répertoire .m2 contiendra normalement toutes les librairies téléchargées (dans 'repository') par maven au fur et à mesure de son utilisation. Il est possible que ce répertoire devienne assez lourd avec le temps ...<br/>
Afin de le pas encombrer votre compte unix avec ces fichiers, je vous recommande de modifier l'endroit où maven stockera les librairies. Ajouter ceci, en l'adaptant, dans votre fichier "settings.xml" :<br/>
<code>&lt;localRepository&gt;/local/<b>username</b>/m2&lt;localRepository&gt;</code>
</p>

<h3>Pom.xml</h3>

<p>
  Il faut faire de votre projet java, un projet "maven". Cela se fait simplement en ajoutant un fichier "pom.xml" à la racine.<br/>
  Un fichier pom décrit notre projet en "artefact", dans un "group" et possédant une "version".<br/>
  Le projet étant "packagé" selon un format défini.<br/>
</p>

<code><pre>
  &lt;groupId&gt;fr.eservices.<b>xxVotreNomxx</b>&lt;/groupId&gt;
  &lt;artifactId&gt;projet-jee&lt;/artifactId&gt;
  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
  &lt;packaging&gt;war&lt;/packaging&gt;
</pre></code>

<p>
  Le pom contiendra également le nom du projet et différentes informations nécessaires à la compilation ou au packaging de notre projet.<br/>
  Le plus intéressant : cela contiendra des dépendances vers des librairies, qui elles-même peuvent tirer d'autres par dépendances transitives.<br/>
  Les dépendances sont normalement présentes sur un serveur "central" maven. C'est un site regroupant toutes les librairies de projets qui souhaitent être diffusés/utilisés.<br/>
  Il est aussi possible d'ajouter d'autres "repository" par de la configuration dans le pom, ou dans les settings de maven.<br/>
</p>

<h3>Repository</h3>

<p>
  Les dépendances seront stockée sur votre ordinateur dans un repository local, par défaut dans ~/.m2/repository.<br/>
  Il est possible d'ajouter manuellement des librairies dans ce repository. Ce qui peut être utile pour les librairies qui ne sont pas fourni au format maven (avec un pom ou sur le repo central ...).<br/>
</p>

<p>
  La conception interne de maven est modulaire et chaque "plugin" est responsable d'une fonctionnalité. Ces mêmes plugins sont également des artefacts maven disponible sur le repo central et téléchargés au besoin.<br/>
  Ainsi, c'est le plugin "install" qui va gérer les insersions dans le repo local.<br/>
  Pour mettre un jar quelconque dans votre repo local on utilisera la commande :<br/>
  <pre>mvn install:install-file -Dfile=<b>fichier</b>.jar -DgroupId=<b>mon.groupe</b> -DartifactId=<b>nom-librairie</b> -Dversion=<b>version</b> -Dpackaging=<b>typeArtefact</b></pre>
  La version est nécessairement numérique, séparée par des points.<br/>
  typeArtefact, généralement <b>jar</b> est le format du fichier géré pour cette dépendance.
</p>

<h3>Dépendances</h3>

<p>
  Il faut distinguer différents ensembles de dépendances, nommées "scope" dans le vocabulaire maven.<br/>

  &raquo; <i>compile</i> : (par défaut) indique que cette librairie est nécessaire pour la compilation et à l'exécution. <br/>
  &raquo; <i>runtime</i> : uniquement nécessaire à l'exécution.<br/>
  &raquo; <i>provided</i> : sera disponible à l'exécution mais n'est pas fourni par ce projet. Exemple : le "servlet-api" est fourni par tomcat et n'est pas amené par notre projet web. "servlet-api" est donc "provided". Cette librairie reste nécessaire à la compilation.<br/>
  &raquo; <i>test</i> : librairie nécessaire uniquement dans l'exécution de tests unitaires. Exemple : junit.<br/>
</p>

<h3>Structure des dossiers</h3>

<p>
  Par convention, maven supposera une certaine structure de dossier de votre projet : <br/>
  <ul>
      <li>src
        <ul>
          <li>main
          <ul>
            <li>java : les sources principales</li>
            <li>resources : les fichiers de configuration et autre, inclus dans la librairie</li>
            <li>webapp (dans le cas d'un war) : les fichiers, autres que les class et resources, inclus dans le war</li>
          </ul>
          </li>
        </ul>
        <ul>
          <li>test
            <ul>
              <li>java</li>
              <li>resources</li>
            </ul>
          </li>
        </ul>
      </li>
  </ul>
  Le répertoire de compilation sera normalement "target".<br/>
  Tout cela est configurable à travers la directive "build" de votre pom.xml.</br>
</p>

<p>
  Vous trouverez dans ce fichier <a href="files/pom.xml">pom.xml</a> une structure de base décrivant votre projet.<br/>
  Vous pouvez ensuite executer <code>mvn dependency:resolve</code> pour résoudre et télécharger toutes les dépendances.<br/> 
  Elles se rangeront dans votre repo local qui pourra vite devenir assez volumineux si vous travaillez régulièrement avec maven sur différents projets.<br/>
  Rappel : Vous pouvez modifier votre .m2/settings.xml pour modifier l'emplacement où maven rangera toutes les dépendances.<br/>
  Visualisez l'arbre des dépendances avec <code>mvn dependency:tree</code>.
</p>

<h3>Le plugin maven d'eclipse</h3>

<p>
  Eclipse, comme de nombreux IDE, inclut maintenant un plugin pour faciliter la gestion des projets maven.</br>
  Il suffit de passer par le menu "Import" &lt; "Maven" &lt; "Existing maven projects".<br/>
  L'édition du pom est facilitée par un menu présentant les différentes sections, tout en permettant d'éditer directement le source xml du fichier.<br/>
  <br/>
  Ce plugin est fort pratique mais a tendance à consommer beaucoup de mémoire, notamment lors de l'indexation des artefacts disponibles sur les repositories... Et cela peut amener eclipse à planter faute de mémoire suffisante.<br/>
  Pour cette raison, il peut être intéressant d'utiliser le plugin eclipse de maven. Celui-ci génère les fichiers compatibles pour l'import de projet classique JAVA dans éclipse. (voir ci dessous).<br/>
  Ou alors de cocher l'option "Do not automatically update dependencies from remote repositories" dans "Préférences" &lt; "Maven".
</p>

<h3>Le plugin eclipse de maven</h3>

<p>
  Un plugin permet de mettre à jour les dépendances d'éclipse en fonction de ce que contient le pom.xml</br>
  Je parle ici d'un plugin eclipse pour maven, à ne pas confondre avec l'inverse (ex: plugin m2e d'eclipse).<br/>
  Ce plugin va en fait mettre à jour (ou créer) les fichiers .project et .classpath utilisés par eclipse.<br/>
  Cela permettra d'ajouter les dépendances dans le classpath d'eclipse.<br/>
  Pour cela utilisez <code>mvn eclipse:eclipse</code><br/>
  Et rafraîchissez votre projet avec F5, ou clic droit/refresh.<br/> 
</p>

<p>
  <img src="img/eclipse_maven.png" style="float: left; margin: 5px"/> <br/> 
   Il faudra également définir la variable "M2_REPO" dans votre workspace pour indiquer à eclipse où est rangé le repository maven.<br/>
  Rendez-vous dans Outils (ou Eclipse) / Préférence / Java / Build Path / Classpath Variables.<br/>
  Ajouter une variable "M2_REPO" qui pointe vers "home"/.m2/repository<br/>
  <div style="clear: both"> </div>
  L'utilisation d'une variable permet à plusieurs personnes de se partager le fichier ".classpath" sans avoir de soucis avec l'endroit ou se trouve les librairies sur leur environnement de travail. La variable est indépendante du projet, elle est liée au workspace eclipse.
</p>

